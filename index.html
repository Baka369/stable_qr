<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Continuous Video QR Code Scanner</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 640px;
      margin: 0 auto;
      text-align: center;
      padding: 20px;
    }
    #videoContainer {
      position: relative;
      display: inline-block;
    }
    #video {
      max-width: 100%;
      background: #000;
    }
    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }
    #output {
      margin-top: 20px;
      padding: 10px;
      background: #f0f0f0;
      word-wrap: break-word;
    }
    .highlight {
      border: 2px solid red;
    }
  </style>
</head>
<body>
  <h1>Continuous QR Code Video Scanner</h1>
  <div id="videoContainer">
    <video id="video" width="640" height="480" autoplay playsinline></video>
    <canvas id="canvas" width="640" height="480"></canvas>
  </div>
  <div id="output">No QR code detected</div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const output = document.getElementById('output');

    // Store previously detected codes to avoid repeated notifications
    let lastDetectedCode = null;

    // Continuous scanning function
    function scanQRCode() {
      // Check if video has enough data
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        // Clear previous drawings
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw current video frame to canvas
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Get image data from canvas
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        // Attempt to read QR code
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "dontInvert"
        });

        // If QR code detected
        if (code) {
          // Highlight QR code area
          ctx.strokeStyle = "red";
          ctx.lineWidth = 2;
          ctx.strokeRect(
            code.location.topLeftCorner.x, 
            code.location.topLeftCorner.y, 
            code.location.topRightCorner.x - code.location.topLeftCorner.x,
            code.location.bottomLeftCorner.y - code.location.topLeftCorner.y
          );

          // Update output if new code detected
          if (code.data !== lastDetectedCode) {
            output.textContent = `QR Code Detected: ${code.data}`;
            output.style.color = 'green';
            lastDetectedCode = code.data;
          }
        } else {
          // Reset output if no code found
          output.textContent = 'No QR code detected';
          output.style.color = 'black';
        }
      }

      // Continue scanning
      requestAnimationFrame(scanQRCode);
    }

    // Start camera
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: "environment",  // Prefer back camera
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });

        video.srcObject = stream;
        video.setAttribute('playsinline', true);
        video.play();

        // Start scanning when video is ready
        video.onloadedmetadata = () => {
          requestAnimationFrame(scanQRCode);
        };

      } catch (err) {
        console.error('Camera access error:', err);
        output.textContent = `Camera Error: ${err.message}`;
        output.style.color = 'red';
      }
    }

    // Initialize camera when page loads
    startCamera();
  </script>
</body>
</html>
